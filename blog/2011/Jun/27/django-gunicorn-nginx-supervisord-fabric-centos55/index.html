<!DOCTYPE html>
<html lang="en">
<head>
        <title>Setting up Django with Green Unicorn, nginx, supervisord and fabric on CentOS 5.5</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../../../../.././theme/css/main.css" type="text/css" />
        
        <link href="http://kencochrane.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="KenCochrane.net Atom Feed" />
        
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../../../.././css/ie.css"/>
                <script src="../../../../.././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../../../.././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

<a href="https://github.com/kencochrane/kencochrane.github.com">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

        <header id="banner" class="body">
                <h1><a href="../../../../../.">KenCochrane.net </a></h1>
                <nav><ul>
                
                
                
                    <li><a href="../../../../.././about/index.html">About Me</a></li>
                
                    <li><a href="../../../../.././projects/index.html">Projects</a></li>
                
                
                
                    <li class="active"><a href="../../../../.././category/blog.html">blog</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
        
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="blog/2011/Jun/27/django-gunicorn-nginx-supervisord-fabric-centos55/" rel="bookmark"
           title="Permalink to Setting up Django with Green Unicorn, nginx, supervisord and fabric on CentOS 5.5">Setting up Django with Green Unicorn, nginx, supervisord and fabric on CentOS 5.5</a></h1>
      
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="KenCochrane">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2011-06-27T06:48:18">
                Mon 27 June 2011
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="../../../../.././author/ken-cochrane.html">Ken Cochrane</a>
        </address>
        
<p>In <a href="../../../../.././category/blog.html">blog</a>. </p>
<p>tags: <a href="../../../../.././tag/django.html">django</a><a href="../../../../.././tag/python.html">python</a><a href="../../../../.././tag/deployment.html">deployment</a><a href="../../../../.././tag/gunicorn.html">gunicorn</a><a href="../../../../.././tag/supervisord.html">supervisord</a><a href="../../../../.././tag/fabric.html">fabric</a><a href="../../../../.././tag/centos5.html">centos5</a><a href="../../../../.././tag/nginx.html">nginx</a><a href="../../../../.././tag/linux.html">linux</a></p>


</footer><!-- /.post-info -->
      <p>When I first started working with django I deployed my apps using apache and mod_python. Then after a little while I started playing with nginx and switched my setup so that nginx was serving the static content and reverse proxied requests back to apache and mod_python. Not too long after that, I switched out mod_python with mod_wsgi and ran mod_wsgi in daemon mode.</p>
<p>This setup worked well for a while, but one thing I never really liked was the fact that I needed to run apache which is pretty heavy even when you strip out all the unused modules. Apache is great, but all I was really using it for was a router between nginx and mod_wsgi, I wasn't using any of the other features in apache.</p>
<p>I looked at fastcgi and uswgi and they looked good, but for one reason or another I never made the jump. Recently I have been hearing a lot of good things about green unicorn, so I decided to check it out. When I first looked at it, it was fairly new and because of this a little concerned with stability, so I kept and eye on it and watched it mature.</p>
<p>While I was waiting for green unicorn to mature I ended up doing a lot of research on the <a class="reference external" href="http://kencochrane.net/blog/2011/06/django-hosting-roundup-who-wins/">new python hosting services</a> that recently hit the market. Three out of the five services that I looked were using green unicorn, the other two were using uWSGI.</p>
<p>The fact that these three services are basing there new businesses on green unicorn gave it a lot of credibility. Not too long after that I started playing with green unicorn to see what it would take to get my sites up and running.</p>
<p>The first thing that I noticed was that I didn't need to create a wsgi file if I used their gunicorn_django command, which was pretty sweet. The fact that they built it into the service shows you that django is a first class citizen.</p>
<p>The second thing that I noticed was that I needed a way to start up green unicorn and keep it running, something that apache does for you with mod_wsgi. I did a little bit of research and found out that supervisord would work perfectly for what I needed to do with green unicorn.</p>
<p>Because seeing is better then reading, I'll guide you throw the steps that you will need to do in order to get your system setup in a way that will make using green unicorn very easy, especially if you want to run more then one website on your server. I'm going to use a 256MB rackspace cloud instance running centos 5.5.</p>
<div class="section" id="create-a-rackspace-cloud-server">
<h2>Create a rackspace cloud server</h2>
<p>Go into the rackspace cloud server management website and allocate yourself a new 256MB CentOS 5.5 server or if you prefer do the same thing using their API. Now that you have a server and the root password, follow along step by step to get you system all setup.</p>
</div>
<div class="section" id="software-and-versions">
<h2>Software and versions</h2>
<ul class="simple">
<li>RackSpace Cloud Server 256MB</li>
<li>CentOS 5.5</li>
<li>Python 2.6.6</li>
<li>nginx 1.0.4</li>
<li>supervisord 3.0a10</li>
<li>virtualenv 1.6.1</li>
<li>pip 1.0.1</li>
<li>gunicorn 0.12.2</li>
<li>fabric 1.1.0</li>
</ul>
</div>
<div class="section" id="bitbucket-project">
<h2>Bitbucket project</h2>
<p>To make things easier I have created a django bootstrap project directory with all of the file used in the blog post. It is located here, so feel free to clone and fork.</p>
<p><a class="reference external" href="https://bitbucket.org/kencochrane/django-gunicorn-nginx-supervisord-bootstrap/">https://bitbucket.org/kencochrane/django-gunicorn-nginx-supervisord-bootstrap/</a></p>
</div>
<div class="section" id="login-to-server">
<h2>Login to server</h2>
<div class="highlight"><pre>ssh root@&lt;RackSpaceIP&gt;
</pre></div>
</div>
<div class="section" id="update-packages">
<h2>Update packages</h2>
<div class="highlight"><pre>yum -y update
</pre></div>
</div>
<div class="section" id="install-packages">
<h2>Install packages</h2>
<p>You might not need all of these right now, but I normally need these down the line, so doing them all now.</p>
<div class="highlight"><pre>yum -y install emacs readline-devel ncurses-devel libevent-devel glib2-devel libjpeg-devel freetype-devel bzip2 bzip2-devel bzip2-libs openssl-devel pcre pcre-devel gpg make gcc yum-utils unzip
</pre></div>
</div>
<div class="section" id="add-a-django-user-as-a-system-user">
<h2>Add a django user as a system user</h2>
<div class="highlight"><pre>useradd -d /opt/django -m -r django
</pre></div>
</div>
<div class="section" id="set-password-for-django-to-what-ever-you-want">
<h2>Set password for django to what ever you want</h2>
<div class="highlight"><pre>passwd django
</pre></div>
</div>
<div class="section" id="setup-directories">
<h2>Setup directories</h2>
<div class="highlight"><pre>mkdir -p /opt/django
mkdir -p /opt/django/apps
mkdir -p /opt/django/logs
mkdir -p /opt/django/logs/nginx
mkdir -p /opt/django/logs/apps
mkdir -p /opt/django/configs
mkdir -p /opt/django/scripts
mkdir -p /opt/django/htdocs
mkdir -p /opt/django/tmp
mkdir -p /opt/django/configs/nginx
mkdir -p /opt/django/configs/supervisord
mkdir -p /opt/django/apps/my_app
</pre></div>
</div>
<div class="section" id="add-blank-html-page">
<h2>Add blank html page</h2>
<div class="highlight"><pre><span class="nb">echo</span> <span class="s2">&quot;&lt;html&gt;&lt;body&gt;nothing here&lt;/body&gt;&lt;/html&gt; &quot;</span> &gt; /opt/django/htdocs/index.html
</pre></div>
</div>
<div class="section" id="install-zlib">
<h2>Install Zlib</h2>
<div class="highlight"><pre><span class="c"># download from zlib.net</span>
mkdir -p /tmp/downloads
<span class="nb">cd</span> /tmp/downloads
wget http://www.zlib.net/zlib-1.2.5.tar.gz
tar -xvzf zlib-1.2.5.tar.gz
<span class="nb">cd </span>zlib-1.2.5
./configure -s
make install
</pre></div>
</div>
<div class="section" id="install-python-2-6-6">
<h2>Install python 2.6.6</h2>
<p>CentOS 5.5 doesn't come with python2.6 pre installed so we need to do that on our own.</p>
<div class="highlight"><pre>mkdir -p /tmp/downloads
<span class="nb">cd</span> /tmp/downloads
wget http://www.python.org/ftp/python/2.6.6/Python-2.6.6.tgz
tar -xvzf Python-2.6.6.tgz
<span class="nb">cd </span>Python-2.6.6
./configure --enable-shared
make
make altinstall
</pre></div>
</div>
<div class="section" id="add-the-following-to-etc-profile">
<h2>Add the following to /etc/profile</h2>
<p>We need to add the lib path to the LD_LIBRARY_PATH or else you will get an error saying it can't find libpython2.6.so.1.0</p>
<div class="highlight"><pre><span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:/usr/local/lib/:/usr/local/lib64/
</pre></div>
</div>
<div class="section" id="source-the-new-profile">
<h2>Source the new profile</h2>
<div class="highlight"><pre><span class="nb">source</span> /etc/profile
</pre></div>
</div>
<div class="section" id="install-distribute">
<h2>Install distribute</h2>
<div class="highlight"><pre>mkdir -p /tmp/downloads
<span class="nb">cd</span> /tmp/downloads
curl -O http://python-distribute.org/distribute_setup.py
python2.6 distribute_setup.py
</pre></div>
</div>
<div class="section" id="install-pip-virtualenv">
<h2>Install Pip &amp; virtualenv</h2>
<div class="highlight"><pre>mkdir -p /tmp/downloads
<span class="nb">cd</span> /tmp/downloads
curl -O -k https://raw.github.com/pypa/pip/master/contrib/get-pip.py
python2.6 get-pip.py
pip install virtualenv
</pre></div>
</div>
<div class="section" id="install-supervisor">
<h2>Install supervisor</h2>
<div class="highlight"><pre>pip install supervisor
</pre></div>
</div>
<div class="section" id="install-mercurial">
<h2>Install mercurial</h2>
<div class="highlight"><pre>pip install mercurial
</pre></div>
</div>
<div class="section" id="install-nginx">
<h2>Install NGINX</h2>
<div class="highlight"><pre>mkdir -p /tmp/downloads
<span class="nb">cd</span> /tmp/downloads
wget http://nginx.org/download/nginx-1.0.4.tar.gz
tar -xzvf nginx-1.0.4.tar.gz
<span class="nb">cd </span>nginx-1.0.4
./configure --sbin-path<span class="o">=</span>/usr/local/sbin --with-http_ssl_module --with-http_stub_status_module
make
/etc/init.d/nginx stop
sleep 2
sudo make install
sudo chmod +x /usr/local/sbin/nginx
</pre></div>
<div class="section" id="install-my-app">
<h3>Install my app</h3>
</div>
</div>
<div class="section" id="add-first-virtualenv">
<h2>Add first virtualenv</h2>
<div class="highlight"><pre><span class="nb">cd</span> /opt/django/apps/my_app/
virtualenv --distribute --no-site-packages v0.1

<span class="c"># make this a post_create hook?</span>
touch /opt/django/apps/my_app/v0.1/.venv

<span class="nb">cd</span> /opt/django/apps/my_app/v0.1/
hg clone https://bitbucket.org/kencochrane/django-gunicorn-nginx-supervisord-bootstrap my_app

ln -s /opt/django/apps/my_app/v0.1 /opt/django/apps/my_app/current

ln -s /opt/django/apps/my_app/current/my_app/conf/nginx.conf /opt/django/configs/nginx/myapp.conf

ln -s /opt/django/apps/my_app/current/my_app/conf/supervisord.conf /opt/django/configs/supervisord/myapp.conf

<span class="c"># activate the ve</span>
<span class="nb">source</span> /opt/django/apps/my_app/current/bin/activate
<span class="nb">cd</span> /opt/django/apps/my_app/current/my_app/
./bootstrap.py
</pre></div>
</div>
<div class="section" id="configure-nginx">
<h2>Configure nginx</h2>
<div class="highlight"><pre><span class="c"># as root</span>
mkdir -p /etc/nginx
ln -s /opt/django/apps/my_app/current/my_app/server/etc/nginx.conf /etc/nginx/nginx.conf
ln -s /usr/local/nginx/conf/mime.types /etc/nginx/mime.types
ln -s /opt/django/apps/my_app/current/my_app/server/init.d/nginx /etc/init.d/nginx
chmod 755 /etc/init.d/nginx
chkconfig --add nginx
chkconfig nginx on
</pre></div>
</div>
<div class="section" id="configure-supervisord">
<h2>Configure Supervisord</h2>
<div class="highlight"><pre><span class="c"># as root</span>
ln -s /opt/django/apps/my_app/current/my_app/server/etc/supervisord.conf  /etc/supervisord.conf
ln -s /opt/django/apps/my_app/current/my_app/server/init.d/supervisord /etc/init.d/supervisord
chmod 755 /etc/init.d/supervisord
chkconfig --add supervisord
chkconfig supervisord on
</pre></div>
</div>
<div class="section" id="firewall">
<h2>Firewall</h2>
<p>We need to open up the firewall so that we are allowed connection, if you don't know anything about this, check out these links.</p>
<p><a class="reference external" href="http://cloudservers.rackspacecloud.com/index.php/Firewalls">http://cloudservers.rackspacecloud.com/index.php/Firewalls</a>
<a class="reference external" href="http://cloudservers.rackspacecloud.com/index.php/Introduction_to_iptables">http://cloudservers.rackspacecloud.com/index.php/Introduction_to_iptables</a>
<a class="reference external" href="http://cloudservers.rackspacecloud.com/index.php/Sample_iptables_ruleset">http://cloudservers.rackspacecloud.com/index.php/Sample_iptables_ruleset</a></p>
<div class="highlight"><pre><span class="c"># Open http port 80</span>
iptables -I RH-Firewall-1-INPUT -p tcp --dport 80 -j ACCEPT
</pre></div>
</div>
<div class="section" id="bashrc-file-changes">
<h2>.bashrc file changes</h2>
<p>I can't remember where I saw this little trick, if you know please let me know so that I can give them credit. If you put a file in your mercurial directory called .venv, when you cd into the directory this little bash hack will automatically activate your virtual environment for you. This allows you to have something similar to virtualenvwrapper in this custom setup.</p>
<p>Add this code to the .bashrc file</p>
<div class="highlight"><pre>emacs /opt/django/.bashrc
<span class="c">#</span>
<span class="c"># User specific aliases and functions</span>
has_virtualenv<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -e .venv <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>deactivate &gt;/dev/null 2&gt;&amp;1
        <span class="nb">source </span>bin/activate
    <span class="k">fi</span>
<span class="o">}</span>

venv_cd <span class="o">()</span> <span class="o">{</span>
    <span class="nb">cd</span> <span class="s2">&quot;$@&quot;</span> <span class="o">&amp;&amp;</span> has_virtualenv
<span class="o">}</span>

<span class="nb">alias cd</span><span class="o">=</span><span class="s2">&quot;venv_cd&quot;</span>

<span class="c">#end of changes</span>

<span class="c"># source the file to get new changes in active shell</span>
<span class="nb">source</span> /opt/django/.bashrc
</pre></div>
</div>
<div class="section" id="change-permissions-of-the-django-home-directory-to-django">
<h2>Change permissions of the django home directory to django</h2>
<p>This cleans up and left over root ownership</p>
<div class="highlight"><pre>chown -R django:django /opt/django/*
</pre></div>
</div>
<div class="section" id="switch-to-django-user">
<h2>Switch to django user</h2>
<div class="highlight"><pre>su - django
</pre></div>
</div>
<div class="section" id="start-up-nginx">
<h2>Start up nginx</h2>
<div class="highlight"><pre>service nginx start
</pre></div>
</div>
<div class="section" id="startup-supervisord">
<h2>Startup supervisord</h2>
<div class="highlight"><pre>service supervisord start
</pre></div>
</div>
<div class="section" id="test-nginx-and-supervisord">
<h2>Test Nginx and supervisord</h2>
<p>Check supervisord status</p>
<div class="highlight"><pre>supervisorctl status
my_app                           RUNNING    pid 13594, uptime 0:00:05
</pre></div>
<p>To check nginx go to the IP or domain name for your rackspace server in your browser and make sure it worked.</p>
</div>
<div class="section" id="updating-the-application-using-fabric">
<h2>Updating the application using fabric</h2>
<p>Inside of the bitbucket project directory there is a file called fabfile.py. This file will allow you to update the application from your machine whenever you want just by calling one command.</p>
<p>It will prompt you for your hostname and password for the django user. Then it will go out to the rackspace server and pull and update the app and restart the application in supervisord. It is very basic for right now, but should get you started if you want to do more advanced stuff.</p>
<div class="highlight"><pre>fab update_server
</pre></div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Now that we have everything setup, if you want to add a new application to our setup all we need to do is.</p>
<ul class="simple">
<li>create a new directory under apps</li>
<li>create the virtualenv</li>
<li>run the bootstrap to install the software</li>
<li>make sure that the application has a supervisord and nginx configuration file</li>
<li>symlink those files to the correct locations in the config directory</li>
<li>run any python management commands you might need to run (syncdb, migrate, etc)</li>
<li>reload supervisord and nginx</li>
<li>you should be good to go.</li>
</ul>
<p>I hope this was helpful to someone besides myself, if it was helpful for you please let me know in the comments.</p>
</div>

    </div><!-- /.entry-content -->
    
    <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "blog/2011/Jun/27/django-gunicorn-nginx-supervisord-fabric-centos55/";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://kencochrane.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    

  </article>
</section>

        <section id="extras" class="body">
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://kencochrane.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/kencochrane">twitter</a></li>
                        
                            <li><a href="https://github.com/kencochrane">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-67696-11']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>



<script type="text/javascript">
    var disqus_shortname = 'kencochrane';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>